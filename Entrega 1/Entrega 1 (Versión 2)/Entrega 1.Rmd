---
title: Control Estadístico de Calidad
authors:
  - name: Michel Mendivenson Barragán Zabala
    department: Departamento de Estadística
    affiliation: Universidad Nacional de Colombia
    email: mbarraganz@unal.edu.co
  - name: Juan Sebastián Huertas Pirajan
    department: Departamento de Estadística
    affiliation: Universidad Nacional de Colombia
    email: juhuertasp@unal.edu.co
  - name: Diego Andres Paez Molina
    department: Departamento de Estadística
    affiliation: Universidad Nacional de Colombia
    email: dpaezm@unal.edu.co
output: 
  rticles::arxiv_article
header-includes:
  # La siguiente línea es para eliminar el enumerado de las secciones declaradas con ##
  - \setcounter{secnumdepth}{0}
  # - usepackage{float}
  # La siguiente línea es para eliminar el título del abstract
  - \renewenvironment{abstract}{}{}
  - \renewcommand{\theenumi}{\alph{enumi}}
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.align = 'center',  out.width = "\\textwidth", out.extra = "keepaspectratio=false", fig.pos = 'H')

# Para habilitar la opción de cambiar el tamaño fuente del código
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
```


#### \small Ejercicio 1: Sea $X \sim N(\mu, \sigma)$ una característica de calidad. Mediante simulaciones, establezca el comportamiento del *ARL* (en control y fuera de él) de las Cartas $R$ y $S$ para observaciones normales con límites $3\sigma$ y muestras de tamaño (a) $n = 3$ y (b) $n = 10$ ¿Qué regularidades observa? \newline \newline

\small Para la solución de este ejercicio, se usarán las siguientes dos funciones:

```{r Funciones ejercicio 1,code = readLines('../Funciones/RunLength.R'), size = 'footnotesize'}
```

\small Que corresponden respectivamente a una función de muestrea mediante simulación longitudes de corrida de la carta $S$ y la carta $R$ respectivamente. Se toman 80 corrimientos a intervalos regulares con $k$ siendo el valor del corrimiento y $k \in [1,3]$ y tomando 1000 muestras de la distribución de la longitud de corrida de cada una de las cartas. Además, como los parámetros específicos de estas cartas no deberían modificar el comportamiento de las cartas se decide tomar la distribución normal para generar las muestras de los subgrupos racionales. Los resultados se encuentran a continuación (Tenga en cuenta que aquí el corrimiento está dado por $k \times \sigma_0$):

```{r echo = FALSE,fig.height=4.5, fig.width = 12, fig.cap ='Comparación de ARL para distintos tamaños de muestra (Cartas S y R).'}
library(latex2exp)
resultadosP1 = read.csv('../Resultados/Punto 1', row.names = 1)
colnames(resultadosP1) = gsub("k....", "k = ",colnames(resultadosP1))
colores = c('red', 'blue', 'red', 'blue'); corrimientos = as.numeric(gsub('k = ', '', colnames(resultadosP1)))
par(mfrow = c(1,2),mar = c(5.1,4.1,4.1,0))
plot(x = NULL, y = NULL, ylim = range(resultadosP1), xlim = range(corrimientos), main = 'Comparación ARL (n = 3)',
     ylab = 'Tiempo de alerta', xlab = TeX('$\\sigma_1 = \\sigma_0 \\times (k + 1$)'),cex.lab = 0.8)
abline(v = seq(1, 3, by = 0.1), col = 'gray', lwd = 0.8, lty = 'dashed')
mtext(bquote(bold('El proceso estable N(0,1)')), side = 3, line = 0.5,adj = 0.5, cex = 0.8, col = 'darkgray')
for (i in 1:2){
  lines(x = corrimientos, y = resultadosP1[i,], col = colores[i], lwd = 1.5)
  # segments(x0 = corrimientos, y0 = as.numeric(resultadosP1[i,] - 1), x1 = corrimientos, y1 = as.numeric(resultadosP1[i,] + 1), col = colores[i], lty = 'solid')
}

legend('topright',legend = c('Carta R', 'Carta S'), col = colores[1:2], lty = 'solid',bty = 'n', horiz = T)
par(mar = c(5.1,1.5,4.1,2.1))
plot(x = NULL, y = NULL, ylim = range(resultadosP1), xlim = range(corrimientos),
     main = 'Comparación ARL (n = 10)', yaxt = 'n', xlab = TeX('$\\sigma_1 = \\sigma_0 \\times (k + 1$)'), cex.lab = 0.8)
abline(v = seq(1, 3, by = 0.1), col = 'gray', lwd = 0.8, lty = 'dashed')
mtext(bquote(bold('El proceso estable es N(0,1)')), side = 3, line = 0.5, adj = 0.5, cex = 0.8, col = 'darkgray')
for (i in 3:4){
  lines(x = corrimientos, y = resultadosP1[i,], col = colores[i], lwd = 1.5)
  # segments(x0 = corrimientos, y0 = as.numeric(resultadosP1[i,] - 1), x1 = corrimientos, y1 = as.numeric(resultadosP1[i,] + 1), col = colores[i], lty = 'solid')
}
legend('topright',legend = c('Carta R', 'Carta S'), col = colores[1:2], lty = 'solid', bty = 'n', horiz = T)
```

De estas gráficas, es posible concluir que, bajo normalidad, la carta $R$ para tamaños de muestra 3 tiene mejor desempeño que la carta $S$ pues en promedio las señales provenientes de esta carta tienen longitud de corrida más larga cuando no hay corrimiento y a su vez detecran más rápido los niveles de corrimiento. En cambio, lo opuesto ocurre con las muestras de tamaño 10, la carta $S$ demuestra mejor desempeño que la carta R. Estas diferencias pueden ser detectados de mejor forma en la siguiente tabla (Recuerde que $k$ se refiere al corrimiento de $\sigma_0$ en unidades de $\sigma_0$):

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(kableExtra)
library(xtable)
library(dplyr)
# tabla = xtable(t(resultadosP1[seq(1,41,by = 4)]), # align = 'l|cccc', 
#                digits = 2, caption = "Comparación de ARL para distintos tamaños de muestra (Cartas S y R).")
# xtable2kable(tabla, booktabs = T)

Presentacion = t(resultadosP1[seq(1,61,by = 4)])
rownames(Presentacion) = c('k = 0', 'k = 0.1', 'k = 0.2', 'k = 0.3', 'k = 0.4', 'k = 0.5', 
             'k = 0.6', 'k = 0.7', 'k = 0.8', 'k = 0.9', 'k = 1', 'k = 1.1', 'k = 1.2',
             'k = 1.3', 'k = 1.4', 'k = 1.5')

kable(Presentacion, booktabs = TRUE) %>%
  kable_styling(latex_options = c("striped", "hold_position")) %>%
  column_spec(1, bold = TRUE)  %>%
  footnote("Comparación de ARL para distintos tamaños de muestra (Cartas S y R).", general_title = 'Tabla 1: ', footnote_as_chunk = TRUE) %>% 
  row_spec(0, bold = TRUE,hline_after = TRUE) # %>%
  # add_header_above(c(" " = 1, "Resultados" = 4))
```


#### \small Ejercicio 2: Sea $X \sim N(\mu, \sigma)$ una característica de calidad. Se sabe que los valores objetivo de los parámetros del proceso son $\mu = \mu_0$ y $\sigma = \sigma_0$. Construir las curvas OC de la carta $S^2$ con límites de probabilidad. Interpretar los resultados \newline \newline



\small Recordemos que los límites de probabilidad de una carta de control $S^2$ se calculan usando la distribución chi-cuadrada ($UCL = \frac{\sigma^2_0}{n-1} \chi^2_{(1 - \alpha / 2;\,\,\, n -1)}$ y $LCL = \frac{\sigma^2_0}{n-1} \chi^2_{(\alpha / 2;\,\,\, n -1)}$), esto debido a que la variable aleatoria definida como $\frac{(n-1)S^2}{\sigma^2}$ tiene distribución $\chi^2$ con $n-1$ grados de libertad. Lo que nos interesa calcular es la probabilidad $P(LCL < S^2 < UCL | \sigma^2 = \sigma^2_1)$:

\small \begin{align*}
P\left(LCL < \frac{(n-1)S^2}{\sigma^2} < UCL | \sigma^2 = \sigma^2_1\right) &= P\left(LCL < \frac{(n-1)S^2}{\sigma^2_1} < UCL\right)\\
&= P\left(\frac{(n-1)LCL}{\sigma^2_1} < S^2 < \frac{(n-1)UCL}{\sigma^2_1}\right) \\
&= P\left(\chi^2_{(n-1)} < \frac{(n-1)UCL}{\sigma^2_1}\right) - P\left(\chi^2_{(n-1)} < \frac{(n-1)LCL}{\sigma^2_1}\right)
\end{align*} 

Y calculando estas probabilidades podremos graficar las curvas OC. Las curvas de operación característica para la carta de control $S^2$ se generarán usando la siguiente función:

```{r Ocs2, code = readLines('../Funciones/OCs2.R'), size = 'footnotesize' }
```

```{r OCs2Application, fig.cap = 'Curvas de operación característica para carta S²',fig.width= 8,echo = FALSE, warning=FALSE}
source('../Funciones/OCs2.R')
par(mar = c(5,5,4,4)); colores = c('red', 'blue', 'darkgreen', 'orange')
plot(x = NULL, y = NULL, ylim = c(0,1), xlim = c(0,8),main = TeX('\\textbf{Curvas OC para carta} ${S^2}$'),
<<<<<<< HEAD
     xlab = TeX('Corrimiento $k$ ($\\sigma^2_1 = \\sigma_0^2 (k+1)$)'),ylab = TeX('$\\beta$'), cex.axis = 0.8,
=======
     xlab = TeX('Corrimiento $k$ ($\\sigma^2_1 = \\sigma_0^2 + k$)'),ylab = TeX('$\\beta$'), cex.axis = 0.8,
>>>>>>> a315f923dbe76f565cef8a0f3a62a451e01e5a66
     cex.lab = 0.7)

legend(x = "right",inset = c(-0.135, 0), col = colores, lwd = 2, xpd = TRUE, bty = 'n', cex = 0.6,
       legend = c('\nn = 5,10,\n     15,20', '\nn = 25,30,\n     25,40','\nn = 45,50,\n     55,60','\nn = 65,70,\n     75,80'))
mtext(bquote(bold('El proceso estable distribuye N(0,1)')), side = 3, line = 0.5, adj = 0.5, cex = 0.8, col = 'darkgray')
abline(v = seq(1, 6, by = 0.5), col = 'gray', lty = 'dashed');abline(h = seq(0,1, by = 0.1), col = 'gray', lty = 'dashed')
for (n in 1:16){curve(expr = OCs2(n * 5, corrimiento = x),from = 0,to = 8, add = T, col = rep(colores, each = 4)[n])}
```

El incremento en el tamaño de los subgrupos racionales se realiza en múltiplos de 5 para obtener un gráfico más entendible y útil. La carta $S^2$ demuestra ser más efectiva para muestras más grandes y además de esto, a partir de tamaños de alrededor de 50 no es realmente productivo intentar aumentar $n$ pues la relación costo-beneficio puede llegar a no ser óptima pues la mejora obtenida a cambio del aumento de $n$ no es suficiente. Finalmente, se observa que para corrimientos $\sigma^2_1 = \sigma^2_0 + 1.5$ se obtiene una probabilidad de detectar el cambio en el siguiente subgrupo racional de más del 50% para $n > 15$ por lo que esta carta es más útil para procesos en que sea posible tomar más de 15 muestras por subgrupo.

#### \small Ejercicio 3: Sea $X \sim N(\mu_0, \sigma_0)$ una característica de calidad. Construya la carta $\bar{X}$ para el monitoreo de la media del proceso. Genere 10 muestras de tamaño $n$ provenientes de $X$, de tal modo que la media muestral de ninguna de ellas caiga fuera de los límites de control. A partir del undécimo momento de monitoreo se pide generar muestras del mismo tamaño $n$ provenientes de una distribución normal con media $\mu_1 = \mu_0 + k\sigma_0$ y $\sigma_1 = \sigma_0$ (con $k = 1,0$) hasta que la carta emita una señal por primera vez. Si se asume que el proceso caracterizado por $X$ es estable y que se desconoce el momento en el cual se produjo el incremento en el nivel medio, ¿en qué muestra ocurrió el cambio en la media del proceso más probablemente?

<<<<<<< HEAD
Tal como se plantea en el ejercicio, se simulan los primeros diez subgrupos muestrales de una distribución normal estándar. Es decir, nuestro valor en control de la media debería ser uno. Además, el tamaño de los subgrupos racionales será $n = 5$:

```{r, size = 'footnotesize'}
# Parámetros
mu = 0; sigma = 1; k = 1; n = 5

# Límites de la carta de control teóricos
LCL = mu - 3 * (sigma/sqrt(n)); UCL = mu + 3 * (sigma/sqrt(n))

set.seed(13)                  # Para replicabilidad
muestras = c()                # Objeto para guardar las medidas de control
for (i in 1:10){              # Generación de muestras bajo control
  muestras[i] = mean(rnorm(n = n, mean = mu, sd = sigma))
}

mu = mu + k * sigma           # Cambiando la media del proceso
media = muestras[10]
while (media < UCL & media > LCL){
  media = mean(rnorm(n = n, mean = mu, sd = sigma))
  muestras = c(muestras, media)
}
```



Ahora bien, para calcular el momento $t$ en que más probablemente se produjo el cambio en la medida de control es necesario revisar para que $t < T$ (Teniendo a $T$ como el valor en que la carta emitió una señal) se maximiza la función $\underset{0 \leq t < T}{\text{argmax}} \left[(T - t) (\bar{\bar{X}}_{T,t} - \mu_0)^2\right]$:

```{r, size = 'footnotesize'}
tiempo = 0:(length(muestras)-1)             # Todos los tiempos antes de la señal
señal = length(muestras)                    # Aquí la carta dio una seña

valores = c()
for (t in tiempo){
  Tmt = señal - t
  mediaSeñal = 1/Tmt * sum(muestras[(t+1):señal])
  valores = c(valores,Tmt*(mediaSeñal)^2)   # Aquí nos evitamos -mu_0 porque mu_0 = 0
}
```


```{r, echo = FALSE, fig.align='center', fig.cap = 'Ejercicio para k = 1', fig.width=14}
library(latex2exp)
par(mfrow = c(1,2))

# Gráfico de la estadística para cada tiempo
plot(muestras, type = 'b', ylim = c(LCL,UCL), xlab = 'Tiempo',
     ylab = TeX('\\bf${\\bar{X}}$'), main = TeX('\\bf{Carta de control $\\bar{X}$}'))
points(y = muestras[length(muestras)], x = 12, col = 'red', pch = 15, cex = 1.2)
abline(h = c(UCL,LCL, 0), col = c('red', 'red', 'blue'), lty = 'dashed')
mtext(bquote(bold('k = 1')), side = 3, line = 0.5,adj = 0.5, cex = 0.8, col = 'darkgray')

# Gráfica de la función de verosimilitud
plot(valores, type = 'b', xlab = 'Tiempo', 
     main = 'Función de verosimilitud',
     ylab = TeX('\\bf$(T -t) \\, (\\bar{\\bar{X}}_{T, t} - \\mu_0)^2$'))
abline(v = tiempo[valores == max(valores)]+1, col = 'red', lty = 'dashed')
points(x = tiempo[valores == max(valores)]+1, y = max(valores), pch = 15, col = 'red', cex = 1.2)
mtext(bquote(bold('k = 1')), side = 3, line = 0.5,adj = 0.5, cex = 0.8, col = 'darkgray')
```

Notemos que en este caso, para una desviación de una desviación estándar de la media este método parece identificar de forma correcta el tiempo en el que se presento la desviación de la media ya que en la gráfica de la derecha vemos que la función de verosimilitud se maximiza para $t = 11$ por lo que el último subgrupo racional en teoría (Y en la práctica también) fue el subgrupo 10. Ahora veamos cómo se comporta este método para la carta cuando no se han presentado desviaciones de la media (Básicamente reutilizamos el código anterior): 

```{r, echo = FALSE, fig.align='center', fig.cap = 'Ejercicio para k = 0', fig.width=14}
# Parámetros
mu = 0; sigma = 1; k = 0; n = 5

# Límites de la carta de control teóricos
LCL = mu - 3 * (sigma/sqrt(n)); UCL = mu + 3 * (sigma/sqrt(n))

set.seed(13)                  # Para replicabilidad
muestras = c()                # Objeto para guardar las medidas de control
for (i in 1:10){              # Generación de muestras bajo control
  muestras[i] = mean(rnorm(n = n, mean = mu, sd = sigma))
}

mu = mu + k * sigma           # Cambiando la media del proceso
media = muestras[10]
while (media < UCL & media > LCL){
  media = mean(rnorm(n = n, mean = mu, sd = sigma))
  muestras = c(muestras, media)
}

tiempo = 0:(length(muestras)-1)             # Todos los tiempos antes de la señal
señal = length(muestras)                    # Aquí la carta dio una seña

valores = c()
for (t in tiempo){
  Tmt = señal - t
  mediaSeñal = 1/Tmt * sum(muestras[(t+1):señal])
  valores = c(valores,Tmt*(mediaSeñal)^2)   # Aquí nos evitamos -mu_0 porque mu_0 = 0
}

library(latex2exp)
par(mfrow = c(1,2))

# Gráfico de la estadística para cada tiempo
plot(muestras, type = 'b', ylim = c(LCL,UCL), xlab = 'Tiempo',
     ylab = TeX('\\bf${\\bar{X}}$'), main = TeX('\\bf{Carta de control $\\bar{X}$}'))
points(y = muestras[length(muestras)], x = length(muestras), col = 'red', pch = 15, cex = 1.2)
abline(h = c(UCL,LCL, 0), col = c('red', 'red', 'blue'), lty = 'dashed')
mtext(bquote(bold('k = 0')), side = 3, line = 0.5,adj = 0.5, cex = 0.8, col = 'darkgray')

# Gráfica de la función de verosimilitud
plot(valores, type = 'b', xlab = 'Tiempo', 
     main = 'Función de verosimilitud',
     ylab = TeX('\\bf$(T -t) \\, (\\bar{\\bar{X}}_{T, t} - \\mu_0)^2$'))
abline(v = tiempo[valores == max(valores)]+1, col = 'red', lty = 'dashed')
points(x = tiempo[valores == max(valores)]+1, y = max(valores), pch = 15, col = 'red', cex = 1.2)
mtext(bquote(bold('k = 0')), side = 3, line = 0.5,adj = 0.5, cex = 0.8, col = 'darkgray')
```

En este caso, la gráfica de la derecha nos dice que el momento en que parece más probable que hubiera ocurrido una posible desviación de la media es el momento en que se detecto la señal por lo que se puede justificar a esta como una herramienta útil no solamente para identificar el momento en que se presenta la desviación de la media sino también para obtener pistas de la índole de la desviación de la carta (Aleatoriedad pura o realmente un cambio en el proceso).

#### \small Ejercicio 4: Sea $X \sim N(\mu_0, \sigma_0)$ una característica de calidad. Se pide:
=======


#### \small Ejercicio 4: Sea $X \sim N(\mu_0, \sigma_0)$ una característica de calidad. Se pide:\
>>>>>>> a315f923dbe76f565cef8a0f3a62a451e01e5a66

\bf \small

\begin{enumerate}
  \item Mediante simulaciones, establezca el comportamiento del ARL de la Carta $\bar{X}$ con límites tres sigma para observaciones normales.
  \item Genere 20 subgrupos racionales de tamaño $n = 3$ provenientes de $X$. Asúmase que el proceso es estable en cuanto a dispersión y con los subgrupos iniciales, construya la carta $\bar{X}$ como es habitual hasta verificar la estabilidad del proceso. Establezca el comportamiento del ARL para la carta que se obtiene del análisis de Fase I realizado.
  \item Repetir lo indicado en el literal (b) con 50 subgrupos racionales de tamaño $n = 3$. Comente los resultados.
\end{enumerate}
